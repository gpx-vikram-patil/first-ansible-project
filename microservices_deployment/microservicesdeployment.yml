- hosts: all
  gather_facts: yes
  become: yes
  
  tasks:
  
  - name: Create a directory if it does not exist
    file:
      path: /home/deployment/app/jars
      state: directory
      owner: '{{ devuser }}'
      group: '{{ devuser }}'
      mode: '0755'
   
  - name: Create a directory if it does not exist
    file:
      path: /home/deployment/app/dump
      state: directory
      owner: '{{ devuser }}'
      group: '{{ devuser }}'
      mode: '0755'
      
  - name: Create a directory if it does not exist
    file:
      path: /home/deployment/app/payexLogs
      state: directory
      owner: '{{ devuser }}'
      group: '{{ devuser }}'
      mode: '0755'
      
  - name: Create a directory if it does not exist
    file:
      path: /home/deployment/app/output
      state: directory
      owner: '{{ devuser }}'
      group: '{{ devuser }}'
      mode: '0755'
      
  - name: Create a directory if it does not exist
    file:
      path: /home/deployment/app/configs
      state: directory
      owner: '{{ devuser }}'
      group: '{{ devuser }}'
      mode: '0755'
      
  - name: set the dirname variable
    ansible.builtin.set_fact:
      dirname: "{{ ansible_date_time.iso8601_basic_short }}"
  
  - name: "create backup directory"
    file:
      path: /home/ubuntu/backups/{{ ansible_date_time.date }}/{{ dirname }}
      state: directory
      mode: '0777'
      owner: root
      group: root

  - name: backup jar file
    ansible.builtin.copy:
      src: /home/deployment/app/jars/{{ service_name }}-1.0-SNAPSHOT.jar
      dest: /home/ubuntu/backup/{{ ansible_date_time.date }}/{{ dirname }}
      remote_src: yes
      owner: root
      group: root
      mode: '0777'

  - name: download jar file from jenkins
    ansible.builtin.get_url:
      url: '{{ URL }}'
      dest: /home/deployment/app/jars/{{ service_name }}-1.0-SNAPSHOT.jar
      force: yes
      username: '{{ nexus_username }}'
      password: '{{ nexus_password }}'
      mode: '0775'
      owner: '{{ devuser }}'
      group: '{{ devuser }}'

#Run script using script module and get the output from awx console

  - name: stop service
    #remote_user: '{{ devuser }}'
    command: sh /home/deployment/app/stop-{{ service_name }}.sh
    ignore_errors: yes
       
  - name: Pause for 5 seconds for service to stop
    ansible.builtin.pause:
      seconds: 5
 
  - name: Transfer and execute a script.
  #hosts: all
    #remote_user: '{{ dev_user }}'
    #become_user: root
    tasks:
    - script: scripts/start-apiservice.sh
      register: results
    - debug:
        var: results.stdout
    - ignore_errors: yes
 
  - name: Pause for 5 seconds for service to start
    ansible.builtin.pause:
      seconds: 5
      
  - name: check service status
    #remote_user: '{{ devuser }}'
    command: sh /home/deployment/app/status-payex.sh | grep {{ service_name }}
    ignore_errors: yes
